<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Inventaris Barang Pakai Habis - DISPORA Kota Tangerang</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #004aad;
            --secondary: #f8f9fa;
            --accent: #ff6b00;
            --text: #333;
            --light: #fff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--text);
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary);
            color: var(--light);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo img {
            height: 50px;
        }
        
        .logo-text h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .logo-text p {
            font-size: 0.9rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }
        
        nav a {
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        nav a:hover {
            color: var(--accent);
        }

        .profile-menu {
            position: relative;
        }
        .profile-menu img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--light);
        }
        .profile-menu button {
            background-color: transparent;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profile-menu .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--light);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .profile-menu .dropdown-content a {
            color: var(--text);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .profile-menu .dropdown-content a:hover {
            background-color: var(--secondary);
        }

        .profile-menu.active .dropdown-content {
            display: block;
        }

        main {
            padding: 2rem;
            max-width: 1400px;
            margin: 20px auto;
            background-color: var(--light);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Info Boxes styles */
        .info-boxes {
            display: flex;
            justify-content: space-between; /* Use space-between to spread items out */
            gap: 15px; /* Reduced gap between boxes */
            margin-bottom: 2rem;
            text-align: center;
            overflow-x: auto; /* Allow horizontal scrolling */
            padding-bottom: 10px; /* Add some padding for scrollbar if needed */
        }

        .info-box {
            background-color: var(--secondary);
            padding: 1rem; /* Reduced padding */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent boxes from shrinking */
            width: 180px; /* Fixed width for each box to keep them in one row */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.3rem; /* Reduced gap inside the box */
        }

        .info-box h3 {
            color: var(--primary);
            font-size: 1.1rem; /* Slightly increased font size for title */
            margin-bottom: 0.3rem; /* Reduced margin */
            line-height: 1.2; /* Adjust line height for better fit */
            /* Add these two lines for multi-line ellipsis */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
            white-space: normal; /* Allow text to wrap if needed */
        }

        .info-box p {
            font-size: 1.1rem; /* Adjusted font size to accommodate longer numbers */
            font-weight: bold;
            color: var(--accent);
            white-space: nowrap; /* Prevent text from wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
            max-width: 100%; /* Ensure it respects the parent's width */
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-bar {
            display: flex; /* Make search bar a flex container */
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden; /* To ensure border radius applies to children */
            width: 250px; /* Adjust as needed */
        }

        .search-bar input {
            border: none; /* Remove individual input border */
            padding: 0.75rem;
            flex-grow: 1; /* Allow input to take available space */
            font-size: 1rem;
        }
        
        .search-bar input:focus {
            outline: none; /* Remove outline on focus */
        }

        .search-bar button {
            background-color: #f0f0f0; /* Light background for the button */
            border: none;
            padding: 0.75rem;
            cursor: pointer;
            color: var(--text);
            transition: background-color 0.3s ease;
        }

        .search-bar button:hover {
            background-color: #e0e0e0;
        }

        button.add-button {
            background-color: var(--accent);
            color: var(--light);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        button.add-button:hover {
            background-color: #e65c00;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .inventory-table th, .inventory-table td {
            border: 1px solid black; /* Warna garis diubah menjadi hitam */
            padding: 0.8rem;
            text-align: center; /* Default teks rata tengah untuk semua sel */
            font-size: 0.9rem;
        }

        .inventory-table th {
            background-color: var(--primary);
            color: var(--light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .inventory-table thead th { /* Pastikan teks di header juga rata tengah */
            text-align: center;
        }

        .inventory-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .inventory-table tr:hover {
            background-color: #f1f1f1;
        }

        .inventory-table tfoot {
            font-weight: bold;
            background-color: #e9e9e9;
        }
        .inventory-table tfoot td {
            border-top: 2px solid var(--primary);
        }

        /* Spesifik untuk sel total yang berisi angka */
        .inventory-table tfoot td[id$="Unit"],
        .inventory-table tfoot td[id$="Rp"] {
            text-align: right; /* Ratakan teks total Unit dan Rp ke kanan */
        }

        /* Spesifik untuk sel pertama di tfoot (Total Keseluruhan) */
        .inventory-table tfoot td:first-child {
            text-align: right; /* Ratakan teks "Total Keseluruhan:" ke kanan */
        }


        .action-buttons button {
            background-color: var(--primary);
            color: var(--light);
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .action-buttons button.edit-button:hover {
            background-color: #003a80;
        }

        .action-buttons button.delete-button {
            background-color: #dc3545;
        }

        .action-buttons button.delete-button:hover {
            background-color: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--light);
            margin: auto;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal-content h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .modal-buttons button.save-button {
            background-color: var(--primary);
            color: var(--light);
            border: none;
            transition: background-color 0.3s ease;
        }

        .modal-buttons button.save-button:hover {
            background-color: #003a80;
        }

        .modal-buttons button.cancel-button {
            background-color: #6c757d;
            color: var(--light);
            border: none;
            transition: background-color 0.3s ease;
        }

        .modal-buttons button.cancel-button:hover {
            background-color: #5a6268;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            color: #777;
            font-size: 0.9rem;
            margin-top: 2rem;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            nav ul {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-bar {
                width: 100%; /* Make search bar full width on small screens */
            }
            button.add-button {
                width: 100%;
            }
            /* Info boxes will now scroll horizontally on small screens */
            .info-boxes {
                justify-content: flex-start; /* Align boxes to the start when scrolling */
            }
            .info-box {
                width: 120px; /* Further reduced fixed width for better fit on small screens */
                padding: 0.8rem; /* Further reduced padding */
            }
            .info-box h3 {
                font-size: 0.9rem; /* Slightly smaller for mobile title */
            }
            .info-box p {
                font-size: 1.2rem; /* Slightly smaller for mobile numbers */
            }
            .inventory-table th, .inventory-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Logo DISPORA">
            <div class="logo-text">
                <h1>DISPORA KOTA TANGERANG</h1>
                <p>Sistem Inventaris Barang Pakai Habis</p>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Beranda</a></li>
		<li><a href="barangmasuk1.html">Barang Masuk</a></li>
                <li><a href="inventaris.html">Inventaris</a></li>
                <li><a href="laporan.html" class="active">Laporan</a></li>
                <li><a href="pengaturan.html">Pengaturan</a></li>
            </ul>
        </nav>
        <div class="profile-menu" id="profileMenu">
            <button>
                <img src="logo.png" alt="Logo DISPORA"> Admin
            </button>
            <div class="dropdown-content">
                <a href="profile.html">Profil</a>
                <a href="settings.html">Pengaturan</a>
                <a href="login.html">Logout</a>
            </div>
        </div>
    </header>

    <main>
        <h2>Data Barang Masuk</h2>

        <div class="info-boxes">
            <div class="info-box">
                <h3>Total Saldo Awal (Unit)</h3>
                <p id="totalInfoInitialBalanceUnit">0</p>
            </div>
            <div class="info-box">
                <h3>Total Saldo Awal (Rp.)</h3>
                <p id="totalInfoInitialBalanceRp">Rp 0,00</p>
            </div>
			<div class="info-box">
                <h3>Total Penerimaan (Pengadaan Baru) (Unit)</h3>
                <p id="totalInfoNewReceiptUnit">0</p>
            </div>
            <div class="info-box">
                <h3>Total Penerimaan (Pengadaan Baru) (Rp.)</h3>
                <p id="totalInfoNewReceiptRp">Rp 0,00</p>
            </div>
            <div class="info-box">
                <h3>Total Pengeluaran (Unit)</h3>
                <p id="totalInfoExpenditureUnit">0</p>
            </div>
            <div class="info-box">
                <h3>Total Pengeluaran (Rp.)</h3>
                <p id="totalInfoExpenditureRp">Rp 0,00</p>
            </div>
            <div class="info-box">
                <h3>Total Saldo Akhir (Unit)</h3>
                <p id="totalInfoFinalStockUnit">0</p>
            </div>
            <div class="info-box">
                <h3>Total Saldo Akhir (Rp.)</h3>
                <p id="totalInfoFinalStockRp">Rp 0,00</p>
            </div>
        </div>

        <div class="controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Cari Kode/Nama Barang/Keterangan...">
                <button type="button" id="searchButton"><i class="fas fa-search"></i></button>
            </div>
            <button class="add-button" id="openModal">Tambah Barang</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th rowspan="2">No.</th>
                        <th rowspan="2">Kode Barang</th>
                        <th rowspan="2">Nama Barang / Spesifikasi Barang</th>
                        <th rowspan="2">Satuan</th>
                        <th rowspan="2">Harga Satuan (Rp.)</th>
                        <th colspan="2">Saldo Awal</th>
                        <th colspan="2">Penerimaan (Pengadaan Baru)</th>
                        <th colspan="2">Pengeluaran</th>
                        <th colspan="2">Saldo Akhir</th>
                        <th rowspan="2">Keterangan</th>
                        <th rowspan="2">Aksi</th>
                    </tr>
                    <tr>
                        <th>Unit</th>
                        <th>Rp.</th>
                        <th>Unit</th>
                        <th>Rp.</th>
                        <th>Unit</th>
                        <th>Rp.</th>
                        <th>Unit</th>
                        <th>Rp.</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align: left;">Total Keseluruhan:</td>
                        <td id="totalInitialBalanceUnit">0</td>
                        <td id="totalInitialBalanceRp">0,00</td>
                        <td id="totalNewReceiptUnit">0</td>
                        <td id="totalNewReceiptRp">0,00</td>
                        <td id="totalExpenditureUnit">0</td>
                        <td id="totalExpenditureRp">0,00</td>
                        <td id="totalFinalStockUnit">0</td>
                        <td id="totalFinalStockRp">0,00</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 DISPORA Kota Tangerang. All Rights Reserved.</p>
    </footer>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <h3 id="modalTitle">Tambah Barang Baru</h3>
            <form id="itemForm">
                <input type="hidden" id="itemId">
                <div class="form-group">
                    <label for="itemCode">Kode Barang</label>
                    <input type="text" id="itemCode" placeholder="Masukkan Kode Barang" required>
                </div>
                <div class="form-group">
                    <label for="itemName">Nama Barang / Spesifikasi Barang</label>
                    <input type="text" id="itemName" placeholder="Masukkan Nama Barang" required>
                </div>
                <div class="form-group">
                    <label for="itemType">Kategori</label>
                    <select id="itemType" required>
                        <option value="">Pilih Kategori</option>
                        <option value="ATK">ATK</option>
                        <option value="Elektronik">Elektronik</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Kebersihan">Kebersihan</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemUnit">Satuan</label>
                    <select id="itemUnit" required>
                        <option value="">Pilih Satuan</option>
                        <option value="Pcs">Pcs</option>
                        <option value="Rim">Rim</option>
                        <option value="Box">Box</option>
                        <option value="Pack">Pack</option>
                        <option value="Set">Set</option>
                        <option value="Unit">Unit</option>
                        <option value="Roll">Roll</option>
                        <option value="Dus">Dus</option>
                        <option value="Botol">Botol</option>
                        <option value="Liter">Liter</option>
                        <option value="Meter">Meter</option>
                        <option value="Buah">Buah</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Harga Satuan (Rp.)</label>
                    <input type="number" id="itemPrice" placeholder="Masukkan Harga Satuan" required>
                </div>
                <div class="form-group">
                    <label for="itemDate">Tanggal Masuk</label>
                    <input type="date" id="itemDate" required>
                </div>
                <div class="form-group">
                    <label for="initialBalanceUnit">Saldo Awal (Unit)</label>
                    <input type="number" id="initialBalanceUnit" placeholder="Masukkan Saldo Awal Unit" value="0" required>
                </div>
                <div class="form-group">
                    <label for="initialBalanceRp">Saldo Awal (Rp.)</label>
                    <input type="number" id="initialBalanceRp" placeholder="Saldo Awal Rupiah Otomatis" value="0" readonly>
                </div>
                <div class="form-group">
                    <label for="newReceiptUnit">Penerimaan (Pengadaan Baru) (Unit)</label>
                    <input type="number" id="newReceiptUnit" placeholder="Masukkan Penerimaan (Pengadaan Baru) Unit" value="0" required>
                </div>
                <div class="form-group">
                    <label for="newReceiptRp">Penerimaan (Pengadaan Baru) (Rp.)</label>
                    <input type="number" id="newReceiptRp" placeholder="Penerimaan (Pengadaan Baru) Rupiah Otomatis" value="0" readonly>
                </div>
                <div class="form-group">
                    <label for="expenditureUnit">Pengeluaran (Unit)</label>
                    <input type="number" id="expenditureUnit" placeholder="Masukkan Pengeluaran Unit" value="0" required>
                </div>
                <div class="form-group">
                    <label for="expenditureRp">Pengeluaran (Rp.)</label>
                    <input type="number" id="expenditureRp" placeholder="Pengeluaran Rupiah Otomatis" value="0" readonly>
                </div>
                <div class="form-group">
                    <label for="finalStockUnit">Saldo Akhir (Unit)</label>
                    <input type="number" id="finalStockUnit" placeholder="Saldo Akhir Unit Otomatis" value="0" readonly>
                </div>
                <div class="form-group">
                    <label for="finalStockRp">Saldo Akhir (Rp.)</label>
                    <input type="number" id="finalStockRp" placeholder="Saldo Akhir Rupiah Otomatis" value="0" readonly>
                </div>
                <div class="form-group">
                    <label for="itemNotes">Keterangan</label>
                    <textarea id="itemNotes" placeholder="Masukkan Keterangan"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button">Simpan</button>
                    <button type="button" class="cancel-button" id="cancelModalButton">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const openModalButton = document.getElementById('openModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelModalButton = document.getElementById('cancelModalButton');
        const itemModal = document.getElementById('itemModal');
        const itemForm = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');

        const itemId = document.getElementById('itemId');
        const itemCode = document.getElementById('itemCode');
        const itemName = document.getElementById('itemName');
        const itemType = document.getElementById('itemType');
        const itemUnit = document.getElementById('itemUnit'); 
        const itemPrice = document.getElementById('itemPrice');
        const itemDate = document.getElementById('itemDate');
        const initialBalanceUnit = document.getElementById('initialBalanceUnit');
        const initialBalanceRp = document.getElementById('initialBalanceRp');
        const newReceiptUnit = document.getElementById('newReceiptUnit'); 
        const newReceiptRp = document.getElementById('newReceiptRp');     
        const expenditureUnit = document.getElementById('expenditureUnit');
        const expenditureRp = document.getElementById('expenditureRp');
        const finalStockUnit = document.getElementById('finalStockUnit');
        const finalStockRp = document.getElementById('finalStockRp');
        const itemNotes = document.getElementById('itemNotes');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton'); 

        // Elements for totals in the table footer
        const totalTableInitialBalanceUnit = document.getElementById('totalInitialBalanceUnit');
        const totalTableInitialBalanceRp = document.getElementById('totalInitialBalanceRp');
        const totalTableNewReceiptUnit = document.getElementById('totalNewReceiptUnit');     
        const totalTableNewReceiptRp = document.getElementById('totalNewReceiptRp');         
        const totalTableExpenditureUnit = document.getElementById('totalExpenditureUnit');
        const totalTableExpenditureRp = document.getElementById('totalExpenditureRp');
        const totalTableFinalStockUnit = document.getElementById('totalFinalStockUnit');
        const totalTableFinalStockRp = document.getElementById('totalFinalStockRp');

        // Elements for totals in the info boxes
        const totalInfoInitialBalanceUnit = document.getElementById('totalInfoInitialBalanceUnit');
        const totalInfoInitialBalanceRp = document.getElementById('totalInfoInitialBalanceRp');
        const totalInfoNewReceiptUnit = document.getElementById('totalInfoNewReceiptUnit');     
        const totalInfoNewReceiptRp = document.getElementById('totalInfoNewReceiptRp');         
        const totalInfoExpenditureUnit = document.getElementById('totalInfoExpenditureUnit');
        const totalInfoExpenditureRp = document.getElementById('totalInfoExpenditureRp');
        const totalInfoFinalStockUnit = document.getElementById('totalInfoFinalStockUnit');
        const totalInfoFinalStockRp = document.getElementById('totalInfoFinalStockRp');

        let inventoryData = JSON.parse(localStorage.getItem('inventoryData')) || [];

        // Function to calculate and update Rp fields and final stock
        function updateCalculatedFields() {
            const price = parseFloat(itemPrice.value) || 0;
            const initialUnit = parseInt(initialBalanceUnit.value) || 0;
            const newReceiptU = parseInt(newReceiptUnit.value) || 0; 
            const expenditureU = parseInt(expenditureUnit.value) || 0;

            // Update the unit input values immediately after parsing to remove leading zeros if any
            initialBalanceUnit.value = initialUnit;
            newReceiptUnit.value = newReceiptU;
            expenditureUnit.value = expenditureU;

            // Calculate Rp values and update read-only fields
            initialBalanceRp.value = (initialUnit * price).toFixed(2);
            newReceiptRp.value = (newReceiptU * price).toFixed(2); 
            expenditureRp.value = (expenditureU * price).toFixed(2);

            // Calculate final stock unit
            // Saldo Akhir Unit: hasil dari (saldo awal + penerimaan pengadaan baru) - unit pengeluaran
            const finalUnit = (initialUnit + newReceiptU) - expenditureU;
            finalStockUnit.value = finalUnit;

            // Calculate final stock Rp based on (finalUnit * price)
            const finalRp = (finalUnit * price); 
            finalStockRp.value = finalRp.toFixed(2);
        }

        // Add event listeners for automatic calculation
        // Handle focus and blur for itemPrice to remove/add '0'
        itemPrice.addEventListener('focus', function() {
            if (this.value === '0') {
                this.value = '';
            }
        });

        itemPrice.addEventListener('blur', function() {
            if (this.value === '' || parseFloat(this.value) === 0) {
                this.value = '0';
            }
            updateCalculatedFields(); // Ensure calculations are updated after blur
        });

        itemPrice.addEventListener('input', updateCalculatedFields);
        initialBalanceUnit.addEventListener('input', updateCalculatedFields);
        newReceiptUnit.addEventListener('input', updateCalculatedFields); 
        expenditureUnit.addEventListener('input', updateCalculatedFields);


        function openModal(item = null) {
            itemModal.style.display = 'flex';
            
            // Clear all fields explicitly before populating for edit or new
            itemId.value = '';
            itemCode.value = '';
            itemName.value = '';
            itemType.value = '';
            itemUnit.value = '';
            itemPrice.value = ''; // Keep it empty for initial input logic
            itemDate.value = '';
            initialBalanceUnit.value = 0;
            initialBalanceRp.value = 0;
            newReceiptUnit.value = 0;
            newReceiptRp.value = 0;
            expenditureUnit.value = 0;
            expenditureRp.value = 0;
            finalStockUnit.value = 0;
            finalStockRp.value = 0;
            itemNotes.value = '';

            if (item) {
                modalTitle.textContent = 'Edit Barang';
                itemId.value = item.id;
                itemCode.value = item.code;
                itemName.value = item.name;
                itemType.value = item.type;
                itemUnit.value = item.unit; 
                itemPrice.value = item.price; // Set existing price
                itemDate.value = item.date;
                initialBalanceUnit.value = item.initialBalanceUnit;
                initialBalanceRp.value = item.initialBalanceRp;
                newReceiptUnit.value = item.newReceiptUnit;     
                newReceiptRp.value = item.newReceiptRp;         
                expenditureUnit.value = item.expenditureUnit;
                expenditureRp.value = item.expenditureRp; 
                finalStockUnit.value = item.finalStockUnit; 
                finalStockRp.value = item.finalStockRp; 
                itemNotes.value = item.notes || '';
                updateCalculatedFields(); 
            } else {
                modalTitle.textContent = 'Tambah Barang Baru';
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                itemDate.value = `${year}-${month}-${day}`;
                updateCalculatedFields(); // Call to set initial 0 values for Rp fields if price is 0
            }
        }

        function closeModal() {
            itemModal.style.display = 'none';
        }

        function calculateAndDisplayTotals(data) {
            let totalInitialUnit = 0;
            let totalInitialRp = 0;
            let totalNewReceiptU = 0;
            let totalNewReceiptRp = 0;
            let totalExpenditureU = 0;
            let totalExpenditureRp = 0;
            let totalFinalUnit = 0;
            let totalFinalRp = 0;

            data.forEach(item => {
                totalInitialUnit += parseInt(item.initialBalanceUnit) || 0;
                totalInitialRp += parseFloat(item.initialBalanceRp) || 0;
                totalNewReceiptU += parseInt(item.newReceiptUnit) || 0;     
                totalNewReceiptRp += parseFloat(item.newReceiptRp) || 0;         
                totalExpenditureU += parseInt(item.expenditureUnit) || 0;
                totalExpenditureRp += parseFloat(item.expenditureRp) || 0;
                totalFinalUnit += parseInt(item.finalStockUnit) || 0;
                totalFinalRp += parseFloat(item.finalStockRp) || 0;
            });

            // Update total fields in the table footer
            totalTableInitialBalanceUnit.textContent = totalInitialUnit;
            totalTableInitialBalanceRp.textContent = totalInitialRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalTableNewReceiptUnit.textContent = totalNewReceiptU;
            totalTableNewReceiptRp.textContent = totalNewReceiptRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalTableExpenditureUnit.textContent = totalExpenditureU;
            totalTableExpenditureRp.textContent = totalExpenditureRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalTableFinalStockUnit.textContent = totalFinalUnit;
            totalTableFinalStockRp.textContent = totalFinalRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Update total fields in the info boxes
            totalInfoInitialBalanceUnit.textContent = totalInitialUnit;
            totalInfoInitialBalanceRp.textContent = `Rp ${totalInitialRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            totalInfoNewReceiptUnit.textContent = totalNewReceiptU;
            totalInfoNewReceiptRp.textContent = `Rp ${totalNewReceiptRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            totalInfoExpenditureUnit.textContent = totalExpenditureU;
            totalInfoExpenditureRp.textContent = `Rp ${totalExpenditureRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            totalInfoFinalStockUnit.textContent = totalFinalUnit;
            totalInfoFinalStockRp.textContent = `Rp ${totalFinalRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }


        function renderInventoryTable(data) {
            inventoryTableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const price = parseFloat(item.price) || 0;
                const initialUnit = parseInt(item.initialBalanceUnit) || 0;
                const initialRp = parseFloat(item.initialBalanceRp) || 0;
                const newReceiptUnitVal = parseInt(item.newReceiptUnit) || 0;
                const newReceiptRpVal = parseFloat(item.newReceiptRp) || 0;
                const expenditureUnitVal = parseInt(item.expenditureUnit) || 0;
                const expenditureRpVal = parseFloat(item.expenditureRp) || 0;
                const finalUnit = parseInt(item.finalStockUnit) || 0;
                const finalRp = parseFloat(item.finalStockRp) || 0;
                const notes = item.notes || '';

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td>${item.unit}</td>
                        <td>${price.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${initialUnit}</td>
                        <td>${initialRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${newReceiptUnitVal}</td>
                        <td>${newReceiptRpVal.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${expenditureUnitVal}</td>
                        <td>${expenditureRpVal.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${finalUnit}</td>
                        <td>${finalRp.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${notes}</td>
                        <td class="action-buttons">
                            <button class="edit-button" data-id="${item.id}">Edit</button>
                            <button class="delete-button" data-id="${item.id}">Hapus</button>
                        </td>
                    </tr>
                `;
                inventoryTableBody.innerHTML += row;
            });

            // After rendering the table, update the totals
            calculateAndDisplayTotals(data);

            // Removed individual event listeners from here
            // They are now handled by event delegation on inventoryTableBody
        }

        openModalButton.addEventListener('click', () => openModal());
        closeModalButton.addEventListener('click', closeModal);
        cancelModalButton.addEventListener('click', closeModal);

        // --- START: Event Delegation for Edit and Delete Buttons ---
        inventoryTableBody.addEventListener('click', function(event) {
            const target = event.target;

            // Handle Edit Button Click
            if (target.classList.contains('edit-button')) {
                const id = target.dataset.id;
                const itemToEdit = inventoryData.find(item => item.id === id);
                if (itemToEdit) {
                    openModal(itemToEdit);
                } else {
                    console.error("Item not found for editing:", id);
                    alert("Terjadi kesalahan: Barang tidak ditemukan.");
                }
            } 
            // Handle Delete Button Click
            else if (target.classList.contains('delete-button')) {
                const id = target.dataset.id;
                if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
                    inventoryData = inventoryData.filter(item => item.id !== id);
                    localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                    renderInventoryTable(inventoryData); // Re-render table after deletion
                }
            }
        });
        // --- END: Event Delegation ---

        itemForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                id: itemId.value || Date.now().toString(),
                code: itemCode.value.trim(), // Trim whitespace from code
                name: itemName.value,
                type: itemType.value,
                unit: itemUnit.value, 
                price: parseFloat(itemPrice.value) || 0,
                date: itemDate.value,
                initialBalanceUnit: parseInt(initialBalanceUnit.value) || 0,
                initialBalanceRp: parseFloat(initialBalanceRp.value) || 0,
                newReceiptUnit: parseInt(newReceiptUnit.value) || 0,
                newReceiptRp: parseFloat(newReceiptRp.value) || 0,
                expenditureUnit: parseInt(expenditureUnit.value) || 0,
                expenditureRp: parseFloat(expenditureRp.value) || 0,
                finalStockUnit: parseInt(finalStockUnit.value) || 0,
                finalStockRp: parseFloat(finalStockRp.value) || 0,
                notes: itemNotes.value || ''
            };

            // --- Duplicate Code Check ---
            const isDuplicateCode = inventoryData.some(item => {
                // If editing, allow the same code for the item being edited
                if (formData.id && item.id === formData.id) {
                    return false; // It's the same item, so its own code is not a duplicate
                }
                // Check if the code matches any other item (case-insensitive and trimmed)
                return item.code.toLowerCase() === formData.code.toLowerCase();
            });

            if (isDuplicateCode) {
                alert('Kode Barang sudah ada. Harap gunakan kode yang berbeda.');
                return; // Stop the submission
            }
            // --- End Duplicate Code Check ---
            
            if (itemId.value) { // If itemId has a value, it's an edit operation
                inventoryData = inventoryData.map(item => 
                    item.id === formData.id ? formData : item
                );
            } else { // If itemId is empty, it's a new item
                inventoryData.push(formData);
            }
            
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            renderInventoryTable(inventoryData);
            closeModal();
        });
        
        // Function to perform search
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = inventoryData.filter(item => 
                (item.name || '').toLowerCase().includes(searchTerm) || 
                (item.code || '').toLowerCase().includes(searchTerm) ||
                (item.notes || '').toLowerCase().includes(searchTerm)
            );
            renderInventoryTable(filteredData);
        }

        // Add event listeners for search
        searchInput.addEventListener('input', performSearch); 
        searchButton.addEventListener('click', performSearch); 

        renderInventoryTable(inventoryData);
        
        // Profile Menu Dropdown functionality
        const profileMenu = document.getElementById('profileMenu');
        if (profileMenu) {
            profileMenu.addEventListener('click', function() {
                this.classList.toggle('active');
            });

            window.addEventListener('click', function(event) {
                if (!event.target.matches('.profile-menu') && !event.target.closest('.profile-menu')) {
                    if (profileMenu.classList.contains('active')) {
                        profileMenu.classList.remove('active');
                    }
                }
            });
        }
    </script>
</body>
</html>
